= PGroonga\n&\nZulip

: author
   Kouhei Sutou
: institution
   ClearCode Inc.
: content-source
   Zulip & PGroonga Night
: date
   2017-09-06
: allotted-time
   30m
: theme
   .

= PGroonga

  * Pronunciation: pÃ­ËzÃ­:lÃºnÉ¡á½±\n
    (('note:èª­ã¿æ–¹ï¼šã´ãƒ¼ã˜ãƒ¼ã‚‹ã‚“ãŒ'))

  * PostgreSQL extension\n
    (('note:PostgreSQLã®æ‹¡å¼µæ©Ÿèƒ½'))
    * Fast full text search\n
      (('note:é«˜é€Ÿå…¨æ–‡æ¤œç´¢æ©Ÿèƒ½'))
    * All languages are supported!\n
      (('note:å…¨è¨€èªå¯¾å¿œï¼'))

= Fast?(('note:ï¼ˆé«˜é€Ÿï¼Ÿï¼‰'))

  * Need to measure to confirm\n
    (('note:ç¢ºèªã™ã‚‹ã«ã¯æ¸¬å®šã—ãªã„ã¨'))
  * Targets(('note:ï¼ˆæ¸¬å®šå¯¾è±¡ï¼‰'))
    * textsearch (built-in)(('note:ï¼ˆçµ„ã¿è¾¼ã¿ï¼‰'))
    * pg_bigm (third party)(('note:ï¼ˆå¤–éƒ¨ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆï¼‰'))

= PGroona and textsearch

  # image
  # src = images/search-pgroonga-textsearch.pdf
  # relative_height = 100

= As fast as textsearch\n(('note:textsearchã¨åŒã˜ãã‚‰ã„ã®é€Ÿã•'))

  * textsearch uses word based full text search\n
    (('note:textsearchã¯å˜èªãƒ™ãƒ¼ã‚¹ã®å…¨æ–‡æ¤œç´¢å®Ÿè£…'))
  * PostgreSQL has enough performance for the approach\n
    (('note:PostgreSQLã¯ã“ã®æ–¹æ³•ã§ã¯ååˆ†ãªæ€§èƒ½ã‚’å‡ºã›ã‚‹'))

= textsearch and Japanese\n(('note:textsearchã¨æ—¥æœ¬èª'))

  * Asian languages including Japanese aren't supported\n
    (('note:æ—¥æœ¬èªã‚’å«ã‚€ã‚¢ã‚¸ã‚¢åœã®è¨€èªã¯éã‚µãƒãƒ¼ãƒˆ'))
    * Need plugin(('note:ï¼ˆãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒå¿…è¦ï¼‰'))
    * Plugin exists but isn't maintained\n
      (('note:ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã¯ã‚ã‚‹ãŒãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã•ã‚Œã¦ã„ãªã„'))

= Japanese support\n(('note:æ—¥æœ¬èªå¯¾å¿œ'))

  * Need one of them(('note:ï¼ˆã©ã¡ã‚‰ã‹ãŒå¿…è¦ï¼‰'))
    * N-gram approach support\n
      (('note:N-gramã¨ã„ã†ã‚„ã‚Šæ–¹ã®ã‚µãƒãƒ¼ãƒˆ'))
    * Japanese specific word based approach support\n
      (('note:æ—¥æœ¬èªã‚’è€ƒæ…®ã—ãŸå˜èªãƒ™ãƒ¼ã‚¹ã®ã‚„ã‚Šæ–¹ã®ã‚µãƒãƒ¼ãƒˆ'))

(('tag:center'))
PGroonga supports both of them\n
ğŸ•º

= PostgreSQL and N-gram\n(('note:PostgreSQLã¨N-gram'))

  * PostgreSQL is slow with N-gram approach\n
    (('note:PostgreSQLã§N-gramã¨ã„ã†ã‚„ã‚Šæ–¹ã‚’ä½¿ã†ã¨é…ã„'))
  * N-gram approach:
    * pg_trgm (contrib)
      * Japanese isn't supported by default\n
        (('note:ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯æ—¥æœ¬èªã«å¯¾å¿œã—ã¦ã„ãªã„'))
    * pg_bigm (third-party)

= PGroona and pg_bigm

  # image
  # src = images/search-pgroonga-pg-bigm.pdf
  # relative_height = 100

= PGroonga is fast stably\n(('note:PGroongaã¯å®‰å®šã—ã¦é€Ÿã„'))

  * PostgreSQL needs "recheck" for N-gram approach\n
    (('note:PostgreSQLã¯N-gramã®ã¨ãã¯ã€Œrecheckã€ãŒå¿…è¦'))
    * Seq search after index search\n
      (('note:ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚µãƒ¼ãƒã®ã‚ã¨ã«ã‚·ãƒ¼ã‚±ãƒ³ã‚·ãƒ£ãƒ«ã‚µãƒ¼ãƒ'))
  * PGroonga doesn't need\n(('note:PGroongaã§ã¯å¿…è¦ãªã„'))
    * Only index search\n
      (('note:ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚µãƒ¼ãƒã ã‘ã§OK'))

= Wrap up\n(('note:ã¾ã¨ã‚'))

  * textsearch is fast but Asian langs aren't supported\n
    (('note:textsearchã¯é€Ÿã„ã‘ã©ã‚¢ã‚¸ã‚¢åœã®è¨€èªã‚’æœªã‚µãƒãƒ¼ãƒˆ'))
  * pg_bigm supports Japanese but is slow for large hits\n
    (('note:pg_bigmã¯æ—¥æœ¬èªå¯¾å¿œã ãŒãƒ’ãƒƒãƒˆæ•°ãŒå¤šããªã‚‹ã¨é…ã„'))
  * PGroonga is fast and supports all languages\n
    (('note:PGroongaã¯é€Ÿãã¦å…¨è¨€èªå¯¾å¿œ'))

= FYI: textsearch, PGroonga and Groonga

  # image
  # src = images/search-pgroonga-groonga-textsearch.pdf
  # relative_height = 100

= Zulip and PGroonga

  * Zulip uses textsearch by default\n
    (('note:Zulipã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§textsearchã‚’ä½¿ç”¨'))
    * Japanese isn't supported\n
      (('note:æ—¥æœ¬èªéå¯¾å¿œ'))
  * Zulip supports PGroonga as option\n
    (('note:Zulipã§PGroongaã‚‚ä½¿ã†ã“ã¨ã‚‚ã§ãã‚‹'))
    * Implemented by me\n
      (('note:ç§ãŒå®Ÿè£…'))

= Zulip: full text search\n(('note:Zulipã¨å…¨æ–‡æ¤œç´¢'))

  * Zulip is chat tool\n
    (('note:Zulipã¯ãƒãƒ£ãƒƒãƒˆãƒ„ãƒ¼ãƒ«'))
    * Latency is important for UX\n
      (('note:UXçš„ã«ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ã¯å¤§äº‹'))
  * Index update is heavy\n
    (('note:ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ›´æ–°ã¯é‡ã„'))
    * Delay index update\n
      (('note:ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ›´æ–°ã‚’å¾Œå›ã—ã«ã—ã¦ã„ã‚‹'))

= Delay index update\n(('note:ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ›´æ–°ã‚’å¾Œå›ã—'))

  # coderay sql
  CREATE TABLE zerver_message (
    rendered_content text,
    -- ... â†“Column for full text search
    search_tsvector tsvector
  ); -- â†“Index for full text search
  CREATE INDEX zerver_message_search_tsvector
    ON zerver_message
    USING gin (search_tsvector);

= Delay index update\n(('note:ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ›´æ–°ã‚’å¾Œå›ã—'))

  # coderay sql

  -- Execute append_to_fts_update_log() on change
  CREATE TRIGGER
    zerver_message_update_search_tsvector_async
    BEFORE INSERT OR UPDATE OF rendered_content
      ON zerver_message
    FOR EACH ROW
      EXECUTE PROCEDURE append_to_fts_update_log();

= Delay index update\n(('note:ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ›´æ–°ã‚’å¾Œå›ã—'))

  # coderay sql

  -- Insert ID to fts_update_log table
  CREATE FUNCTION append_to_fts_update_log()
    RETURNS trigger
    LANGUAGE plpgsql AS $$
      BEGIN
        INSERT INTO fts_update_log (message_id)
          VALUES (NEW.id);
        RETURN NEW;
      END
  $$;

= Delay index update\n(('note:ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ›´æ–°ã‚’å¾Œå›ã—'))

  # coderay sql

  -- Keep ID to be updated
  CREATE TABLE fts_update_log (
    id SERIAL PRIMARY KEY,
    message_id INTEGER NOT NULL
  );

= Delay index update\n(('note:ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ›´æ–°ã‚’å¾Œå›ã—'))

  # coderay sql

  -- Execute do_notify_fts_update_log()
  -- on INSERT
  CREATE TRIGGER fts_update_log_notify
    AFTER INSERT ON fts_update_log
    FOR EACH STATEMENT
      EXECUTE PROCEDURE
        do_notify_fts_update_log();

= Delay index update\n(('note:ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ›´æ–°ã‚’å¾Œå›ã—'))

  # coderay sql

  -- NOTIFY to fts_update_log channel!
  CREATE FUNCTION do_notify_fts_update_log()
    RETURNS trigger
    LANGUAGE plpgsql AS $$
      BEGIN
        NOTIFY fts_update_log;
        RETURN NEW;
      END
    $$;

= Delay index update\n(('note:ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ›´æ–°ã‚’å¾Œå›ã—'))

  # coderay python

  cursor.execute("LISTEN ftp_update_log") # Wait
  cursor.execute("SELECT id, message_id FROM fts_update_log")
  ids = []
  for (id, message_id) in cursor.fetchall():
    cursor.execute("UPDATE zerver_message SET search_tsvector = "
                     "to_tsvector('zulip.english_us_search', "
                                 "rendered_content) "
                   "WHERE id = %s", (message_id,))
    ids.append(id)
  cursor.execute("DELETE FROM fts_update_log WHERE id = ANY(%s)",
                 (ids,))

= PGroonga: index update\n(('note:PGroongaã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ›´æ–°'))

  * PGroonga's index update is fast too\n
    (('note:PGroongaã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ›´æ–°ã‚‚é€Ÿã„'))
  * PGroonga's search while index update is still fast\n
    (('note:PGroongaã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ›´æ–°ä¸­ã®æ¤œç´¢ã‚‚é€Ÿã„'))

= Perf characteristics\n(('note:æ€§èƒ½ã®å‚¾å‘'))

  # image
  # src = images/performance-charcteristic-for-constant-read-and-write.svg
  # relative_height = 100

= Update and lock\n(('note:æ›´æ–°ã¨ãƒ­ãƒƒã‚¯'))

  * Update without ((*read*)) locks\n
    (('note:((*å‚ç…§*))ãƒ­ãƒƒã‚¯ãªã—ã§æ›´æ–°'))
    * ((*Write*)) locks are required\n
      (('note:((*æ›¸ãè¾¼ã¿*))ãƒ­ãƒƒã‚¯ã¯å¿…è¦'))

= GIN: Read/Write\n(('note:GINï¼šèª­ã¿æ›¸ã'))

  # image
  # src = images/read-while-write-gin.svg
  # relative_height = 100

= PGroonga: Read/Write\n(('note:PGroongaï¼šèª­ã¿æ›¸ã'))

  # image
  # src = images/read-while-write-pgroonga.svg
  # relative_height = 100

= Wrap up\n(('note:ã¾ã¨ã‚'))

  * Zulip: Low latency for UX\n
    (('note:Zulipã¯UXã®ãŸã‚ã«ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ã‚’ãŒã‚“ã°ã£ã¦ã„ã‚‹'))
    * Delay index update\n
      (('note:ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ›´æ–°ã¯å¾Œå›ã—'))
  * PGroonga: Keeps fast search with update\n
    (('note:PGroongaã¯æ›´æ–°ã—ãªãŒã‚‰ã§ã‚‚é«˜é€Ÿæ¤œç´¢ã‚’ç¶­æŒ'))
    * Chat friendly characteristics\n
      (('note:ãƒãƒ£ãƒƒãƒˆå‘ãã®ç‰¹æ€§'))

= More PGroonga features\n(('note:PGroongaã®æ©Ÿèƒ½ã„ã‚ã„ã‚'))

  * Query expansion(('note:ï¼ˆã‚¯ã‚¨ãƒªãƒ¼å±•é–‹ï¼‰'))
    * Support synonyms(('note:ï¼ˆåŒç¾©èªæ¤œç´¢ã‚’ã‚µãƒãƒ¼ãƒˆï¼‰'))
  * Similar search(('note:ï¼ˆé¡ä¼¼æ–‡æ›¸æ¤œç´¢ï¼‰'))
    * Find similar messages\n
      (('note:é¡ä¼¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¤œç´¢'))
  * Fuzzy search(('note:ï¼ˆã‚ã„ã¾ã„æ¤œç´¢ï¼‰'))
  * Stemming(('note:ï¼ˆã‚¹ãƒ†ãƒŸãƒ³ã‚°ï¼‰'))

